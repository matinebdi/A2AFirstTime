# Class Diagram - VacanceAI Backend

![Class Diagram](sc/Mermaid%20Chart%20-%20Create%20complex,%20visual%20diagrams%20with%20text.-2026-02-13-090534.png)

## Description

This diagram represents the 11 SQLAlchemy ORM models of the VacanceAI backend and their relationships. Each class maps to an Oracle 21c XE table.

---

## Core Models

### User
Central model representing a platform user.
- UUID identifier generated by Oracle (`SYS_GUID()`)
- Password hashed with bcrypt
- Relationships: owns bookings, favorites, reviews, and refresh tokens

### Destination
Travel location (country + city) with GPS coordinates and categorization tags.
- 15 pre-seeded destinations (one per country)
- Contains an average rating and total review count
- Serialization methods: `to_dict()`, `to_summary_dict()` (without timestamps), `to_minimal_dict()` (name + country + image)

### Package
All-inclusive vacation offer linked to a destination.
- Price per person, duration in days, max capacity
- JSON lists: included, not-included, highlights, image gallery
- Availability period (`available_from` / `available_to`)
- 30 pre-seeded packages (2 per destination: Explorer + Premium)
- Methods: `to_dict_with_destination()` (with nested destination), `to_booking_dict()`, `to_favorite_dict()`

### Booking
A user's reservation for a package.
- Status: `pending`, `confirmed`, `cancelled`
- Payment status: `unpaid`, `paid`, `refunded`
- Automatic total price calculation (`price_per_person * num_persons`)
- Method `to_dict_with_joins()` nests the package and its destination

### Favorite
User-package association (pivot table).
- Unique constraint `UNIQUE(user_id, package_id)`: a package can only be favorited once
- Method `to_dict_with_joins()` nests the package and its destination

### Review
A user's review on a package, optionally linked to a booking.
- Rating from 1 to 5
- Comment stored as Oracle CLOB
- Method `to_dict_with_user()` nests author info (first name, last name, avatar)

### Conversation
Chat history with the AI assistant.
- Identifier provided by the frontend (no `SYS_GUID()`)
- Messages and context stored as JSON in Oracle CLOBs
- `SET NULL` relationship to User (conversation preserved even if user is deleted)

---

## TripAdvisor Models

### TripAdvisorLocation
Hotel imported from the TripAdvisor API.
- `location_id`: unique TripAdvisor identifier
- Address stored as JSON (`address_obj`)
- Rating, review count, price level
- Method `to_dict_with_details()` nests photos, reviews, and computes average rating

### TripAdvisorPhoto
Photo of a TripAdvisor hotel.
- 4 URL sizes: original, large, medium, small
- `uploaded_to_storage` flag for potential migration to custom storage

### TripAdvisorReview
TripAdvisor review for a hotel.
- Author (`username`), location, trip type
- Publication date and travel date

---

## Relationships

| Relationship | Type | Cascade |
|-------------|------|---------|
| User -> RefreshToken | 1:N | CASCADE |
| User -> Booking | 1:N | CASCADE |
| User -> Favorite | 1:N | CASCADE |
| User -> Review | 1:N | CASCADE |
| User -> Conversation | 1:N | SET NULL |
| Destination -> Package | 1:N | CASCADE |
| Package -> Booking | 1:N | - |
| Package -> Favorite | 1:N | CASCADE |
| Package -> Review | 1:N | CASCADE |
| Booking -> Review | 1:N | - |
| TripAdvisorLocation -> TripAdvisorPhoto | 1:N | viewonly (join on `location_id` string) |
| TripAdvisorLocation -> TripAdvisorReview | 1:N | viewonly (join on `location_id` string) |

---

## Custom Oracle Types

| SQLAlchemy Type | Oracle Storage | Usage |
|---|---|---|
| `JSONEncodedCLOB` | CLOB | Tags, included, not_included, highlights, images, messages, context, address_obj |
| `OracleBoolean` | NUMBER(1) | is_active (Package), uploaded_to_storage (Photo) |
| `String(36)` + `SYS_GUID()` | VARCHAR2(36) | All identifiers (except Conversation) |
| `TIMESTAMP(timezone=True)` | TIMESTAMP WITH TIME ZONE | created_at, updated_at, expires_at, published_date |

---

## Key Patterns

- **`joinedload()`**: eager loading of relationships to avoid N+1 queries
- **`to_dict()` and variants**: model serialization to dict/JSON for the API
- **`_f()` helper**: `Decimal` -> `float` conversion for JSON serialization
- **`updated_at`**: managed by Oracle triggers, not SQLAlchemy
- **`sa_text()`**: alias for `sqlalchemy.text` to avoid conflict with `TripAdvisorReview.text`
